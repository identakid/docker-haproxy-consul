global
    maxconn 256
    debug
    log 127.0.0.1 local0
    log 127.0.0.1 local1 notice
defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms

frontend http
    bind *:80
    mode http
    option http-server-close
{{ range services }}{{ if .Name | regexMatch "http" }}
    acl url_{{ .Name }} path_beg /{{ .Name | replaceAll "-http" "" }}
    use_backend {{ .Name }}_backend if url_{{ .Name }}
{{ end }}{{ end }}

{{ range services }}{{ if .Name | regexMatch "http" }}
backend {{ .Name }}_backend
   mode http
   balance roundrobin
   option httplog
   reqrep ^([^\ :]*)\ /{{ .Name | replaceAll "-http" "" }}/(.*) \1\ /\2
{{ range service .Name }}
   server {{ .Node }} {{ .Address }}:{{ .Port }}{{ end }}
{{ end }}{{ end }}
